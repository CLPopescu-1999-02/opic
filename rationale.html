<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OPIC: RATIONALE AND ROADMAP</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OPIC
   </div>
   <div id="projectbrief">Object Persistence In C</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">RATIONALE AND ROADMAP </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In most of the programming models, program operates on in memory objects, and operations on off-heap (disk, network) objects are usually afterthoughts. The off-heap object representations are mostly implemented per application basis, such as database, primitive only serialization format (protobuf, thrift, avro), search engine index, or document format like Microsoft Word. Implementing new serialization formats for every new applications is painful, so we decided to create a general framework to rule it all.</p>
<p>A general purpose serialization framework can do more than that. We target to serialize all possible data structures. BST, Hash table, B+ Tree, suffix array, anything. As you might notice, these are the core data structures to build databases and search engines. Not only should you be able to write a hobby transactional database out of this framework, but you can also build your own NoSQL, multi-layer DB like LevelDB/RocksDB, bitmap based DB like Druid, or experiment new database concepts that no one has seen before. This is one core aspect for ADT (abstract data type) serialization.</p>
<p>This concept can be further extend to serialize the general program state (not yet implemented). The motivation comes from bad experiances on using memory aggressive browsers. The browser performance is not satisfactory when having dozens of browser tabs opened, even though the OS should swap out the memory to disk but it just doesn't perform well. Instead, why not serialize the whole Javascript and DOM state out, and restore it back when user requires it? Our initial attempt is build a lambda calculus engine base on the serialization framework, then optimize its performance and write Javascipt compiler to the lambda form.</p>
<p>If you also feel excited on this project, your contributions and patches are always welcome.</p>
<h2>PROJECT STRUCTURES AND PLANS </h2>
<p>This section describes a high level view of the program abstraction and near future roadmap.</p>
<h3>Language Choice</h3>
<p>Before we jump to the serialization abstraction, let me briefly discuss the language choice. This framework is implemented in pure C, following C11 standard and GCC extensions. C11 is chosen for atomic variables; A subset of GCC extensions are carefully picked in which it has the support from clang as well. Other compiler (Visual Studio, Intel C) support are not considered on current stage of development. The use of GCC extensions are necessary because many important language features do not exist in C99/C11 standards. The extensions we use and plan to use are:</p>
<ul>
<li>constructor function</li>
<li>address alignment</li>
<li>SIMD vector types</li>
<li>may add more if needed.</li>
</ul>
<p>Though breaking portability across multiple compilers could be a problem, we plan to overcome it by using Autoconf configuration to detect compiler supported features before actual compilation. If the feature test failed, it would not try to compile.</p>
<p>Many people asked me why didn't I just use C++ instead. There are two main reasons. First, serializing general types is crucial in C++. You have to serialize the internal C++ structures such as vtable (which is implementation defined), having your own memory allocator to restore load the de-serialized C++ type, and probably trace all the method address of an object. That's too much hack. And since the compiler may use different vtable layout on different versions, you have to test against all possible ones! Nope, not a good idea. Second reason relates to how I want this framework to be used. ALL programming languages has C bindings, and that is a perfect place to hide the complicated internals and expose high level API to end users. For instance, expose a programmable database interface to Python that looks like a regular container. As all the states are written in C, it is also easier to pass it to other language's C bindings.</p>
<p>Same considerations apply to all other possible candidates, including go, rust, swift, OCaml, Haskell, Java, Scala, etc. Unless you can serialize its internal structure easily with deterministic performance, it won't be taken onto the table.</p>
<h3>Generics (completed)</h3>
<p>So, we decided to use C. But it is so featureless! How do we balance out the low level control and high level abstraction to make programming less painful? As you might guess, we use macros to create a DSL. The main feature I tired to implement is generic type and interface (also called traits, or typeclass in haskell). See the following example of how it makes language semantics cleaner.</p>
<div class="fragment"><div class="line">serialize((<span class="keywordtype">void</span>*)obj, fd);</div></div><!-- fragment --><p>A prototype function like above can behave differently with different object instance. If the object has internal object that need to get serialized, simply recursively call <code>serialize</code> again with the internal object.</p>
<p>For now we only implemented generics (method polymorphism), without inheritance support. Though it is not hard but we won't do it until we really need it. Yet, the generics abstraction is already powerful enough for us to write Haskell Monads and Functors in C. See <a href="https://github.com/dryman/opic/tree/master/monad_example">monad_example</a> for how it works.</p>
<h3>Serializable Pointer Machine (completed)</h3>
<p>You can think <a href="https://en.wikipedia.org/wiki/Pointer_machine">pointer machine</a> is a academic synonym to object oriented programming model. It is also a general form of LISP machine which is used by many functional languages.</p>
<p>I follow the Schönhage's SMM (Schönhage's Storage Modification Machine) definition of pointer machine, where the machine is formed by number of "nodes" with a inbound link to the root node. Each node have constant number of field; a field could be an outbound pointer to other node, or a primitive type. Only certain operations are permitted: create (new), destroy (free) nodes, follow the pointers, or mutate the fields in a node. This pretty much models general object oriented program behavior, and it can emulate LISP machine as well.</p>
<p>This model is also carefully picked for other practical reasons.</p>
<ul>
<li>Since pointer machine can only use constant size objects, we can group same type of objects in large chunk of array, and can serialize it in batches.</li>
<li>Compare to the model above, RAM model is harder to manage and make it deterministic on serialization operation.</li>
</ul>
<p>The detail explaination is in <a href="https://github.com/dryman/opic/tree/master/pm_serde_example">pm_serde_example</a>.</p>
<h3>Common Abastract Data Types (TODO)</h3>
<p>Implements common collection types for good code reuse. In contrast to most real time applications, one major use of this library is for serialization which only require good amortized complexity. Therefore we permit and encourage amortized data structures like Fibonacci heap to be included in this library. This unleashes many powerful data structures that only exist in papers but yet used in real world.</p>
<p>Sounds fun, right?</p>
<h3>Primitive Serialization (TODO)</h3>
<ul>
<li>Row based, suite with TX enabled data processing or data stream</li>
<li>Columnar. Type based compression should get examined.</li>
<li>Dremel like nested columnar store. Except repetition number and definition number are not packed with data, but stored separately as integer type. This should improve the compression ratio.</li>
</ul>
<h3>Cache Oblivious Data Structures (TODO)</h3>
<p>See <a href="http://erikdemaine.org/papers/BRICS2002/paper.pdf">Eric Demaine's Note</a>.</p>
<h3>Freezable Lambda Calculus (TODO)</h3>
<p>Implement a simple compute engine that can serialize the whole state at any time. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Apr 29 2017 09:34:28 for OPIC by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
